<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Meu Site com Firebase</title>
</head>
<body>
		<!-- Conteúdo do seu site aqui -->

		<!-- Tela de login -->
		<div id="loginScreen" style="display: flex; flex-direction: column; gap: 8px; max-width: 300px; margin: 40px auto;">
			<form onsubmit="handleLogin(event)">
				<input id="loginUser" type="email" placeholder="Email" required />
				<input id="loginPassword" type="password" placeholder="Senha" required />
				<button type="submit">Entrar</button>
			</form>
		</div>

			<!-- Usuário logado -->
			<div style="text-align:center; margin-top:20px;">
				Usuário atual: <span id="currentUser">—</span>
				<button onclick="logout()">Sair</button>
			</div>

			<!-- Grid de produtos -->
				<div id="productsGrid" style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; margin: 32px 0;"></div>

				<!-- Carrinho e botão de finalizar venda -->
				<div id="cartSection" style="max-width:400px; margin:32px auto; padding:16px; border:1px solid #ccc; border-radius:8px; background:#f9f9f9;">
					<h3>Carrinho</h3>
					<ul id="cartList"></ul>
					<div>Total: R$ <span id="cartTotal">0.00</span></div>
					<button id="finalizeSaleBtn">Finalizar Venda</button>
				</div>

	<!-- coloque isto perto do final do <body>, antes dos seus scripts que usam Firebase -->
		<script type="module">
			// IMPORTS via CDN (exemplo com Firebase v9 modular)
			import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
			import { getFirestore, collection, addDoc, onSnapshot, doc, runTransaction, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
			import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

			// --- Substitua pelos valores que o console do Firebase te deu ---
			const firebaseConfig = {
				apiKey: "SUA_API_KEY",
				authDomain: "SEU_PROJETO.firebaseapp.com",
				projectId: "SEU_PROJETO",
				// ...outros campos
			};

			// Inicializa Firebase
			const app = initializeApp(firebaseConfig);
			const db = getFirestore(app);
			const auth = getAuth(app);

			// Exporte/cole aqui as funções (login, logout, gravar venda etc) que detalho abaixo.
			window._fb = { db, auth }; // (opcional) deixar disponível globalmente para debug

				// Função para renderizar produtos
				function renderProducts(products) {
					const grid = document.getElementById('productsGrid');
					grid.innerHTML = '';
					products.forEach(p => {
						// criar o card do produto usando p.id e p.name, p.price, p.stock
						const div = document.createElement('div');
						div.className = 'product-card';
						div.style = 'border:1px solid #ccc; border-radius:8px; min-width:180px; background:#fafafa;';
						div.innerHTML = `
							<div class="p-3">
								<h4>${p.name}</h4>
								<p>R$ ${p.price.toFixed(2)}</p>
								<p>Estoque: ${p.stock}</p>
								<button onclick="addToCart('${p.id}', ${p.price}, '${p.name}')">Adicionar</button>
							</div>
						`;
						grid.appendChild(div);
					});
				}

				// escuta em tempo real os produtos
				import { query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
				const productsCol = collection(db, 'products');
				const q = query(productsCol, orderBy('name'));
				onSnapshot(q, snapshot => {
					const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
					renderProducts(items);
				});


					// Carrinho simples em memória
					let cart = [];

					function updateCartUI() {
						const cartList = document.getElementById('cartList');
						const cartTotal = document.getElementById('cartTotal');
						cartList.innerHTML = '';
						let total = 0;
						cart.forEach(item => {
							const li = document.createElement('li');
							li.textContent = `${item.name} x${item.quantity} - R$ ${(item.price * item.quantity).toFixed(2)}`;
							cartList.appendChild(li);
							total += item.price * item.quantity;
						});
						cartTotal.textContent = total.toFixed(2);
					}

					window.addToCart = function(id, price, name) {
						const idx = cart.findIndex(i => i.id === id);
						if (idx >= 0) {
							cart[idx].quantity += 1;
						} else {
							cart.push({ id, name, price, quantity: 1 });
						}
						updateCartUI();
					};

					// Função para finalizar venda
					import { addDoc, doc, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
					import { getAuth } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

					async function finalizeSale(cartItems, total) {
						const user = auth.currentUser;
						if (!user) { alert('Faça login antes de finalizar a venda'); return; }

						try {
							// 1) cria o documento de venda
							await addDoc(collection(db, 'sales'), {
								userId: user.uid,
								items: cartItems, // array {id, name, price, quantity}
								total,
								createdAt: new Date()
							});

							// 2) atualiza o estoque com transação para cada produto
							for (const item of cartItems) {
								const productRef = doc(db, 'products', item.id);
								await runTransaction(db, async (transaction) => {
									const prodSnap = await transaction.get(productRef);
									if (!prodSnap.exists()) throw new Error('Produto não encontrado: ' + item.name);
									const currentStock = prodSnap.data().stock || 0;
									const newStock = currentStock - item.quantity;
									if (newStock < 0) throw new Error('Estoque insuficiente para ' + item.name);
									transaction.update(productRef, { stock: newStock });
								});
							}

							alert('Venda registrada com sucesso!');
							cart = [];
							updateCartUI();
						} catch (err) {
							alert('Erro ao finalizar venda: ' + err.message);
						}
					}

					// Listener para botão de finalizar venda
					document.getElementById('finalizeSaleBtn').onclick = function() {
						if (cart.length === 0) { alert('Carrinho vazio!'); return; }
						const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
						finalizeSale(cart, total);
					};

					// Inicializa UI do carrinho
					updateCartUI();

				// chama quando o formulário de login for submetido
			window.handleLogin = async function(event) {
				event.preventDefault();
				const email = document.getElementById('loginUser').value;
				const password = document.getElementById('loginPassword').value;
				try {
					await signInWithEmailAndPassword(auth, email, password);
					// se der certo, onAuthStateChanged (abaixo) vai atualizar a UI
				} catch (err) {
					alert('Erro ao logar: ' + err.message);
				}
			}

			// logout
			window.logout = async function() {
				await signOut(auth);
			}

			// observar estado de autenticação (mostra/oculta tela de login)
			onAuthStateChanged(auth, user => {
				const loginScreen = document.getElementById('loginScreen');
				const currentUserEl = document.getElementById('currentUser');
				if (user) {
					if (loginScreen) loginScreen.style.display = 'none';
					if (currentUserEl) currentUserEl.textContent = user.email;
				} else {
					if (loginScreen) loginScreen.style.display = 'flex';
					if (currentUserEl) currentUserEl.textContent = '—';
				}
			});
		</script>
</body>
</html>
